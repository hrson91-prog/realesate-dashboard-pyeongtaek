<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</title>
    
    <!-- Tailwind CSS (ìŠ¤íƒ€ì¼ë§) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js (ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PapaParse (CSV íŒŒì‹± ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .table-container { max-height: 500px; overflow-y: auto; }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ë§ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        <!-- í—¤ë” ì˜ì—­ -->
        <header class="flex justify-between items-end border-b pb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-gray-500 mt-2 text-sm">êµ¬ê¸€ ì‹œíŠ¸ì˜ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„ëœ ì •ë³´ì…ë‹ˆë‹¤.</p>
            </div>
            <div id="loadingStatus" class="text-sm font-medium text-blue-600 animate-pulse">
                ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
        </header>

        <!-- ìš”ì•½ ì •ë³´ (KPIs) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- ì „ì²´ ê±°ë˜ ê±´ìˆ˜ -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium">ğŸ  ì „ì²´ ê±°ë˜ ê±´ìˆ˜</h3>
                <p class="text-3xl font-bold mt-2 text-gray-900" id="kpi-count">- ê±´</p>
            </div>
            <!-- í‰ê·  ê±°ë˜ ê°€ê²© -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium">ğŸ’° í‰ê·  ê±°ë˜ê°€ê²©</h3>
                <p class="text-3xl font-bold mt-2 text-blue-600" id="kpi-avg">-</p>
            </div>
            <!-- ìµœê³  ê±°ë˜ ê°€ê²© -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium">ğŸ“ˆ ìµœê³  ê±°ë˜ê°€ê²©</h3>
                <p class="text-3xl font-bold mt-2 text-red-500" id="kpi-max">-</p>
            </div>
            <!-- ìµœì € ê±°ë˜ ê°€ê²© -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h3 class="text-gray-500 text-sm font-medium">ğŸ“‰ ìµœì € ê±°ë˜ê°€ê²©</h3>
                <p class="text-3xl font-bold mt-2 text-green-500" id="kpi-min">-</p>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ (ì°¨íŠ¸ & í…Œì´ë¸”) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 lg:col-span-2">
                <h2 class="text-lg font-bold text-gray-800 mb-4">ì›”ë³„ í‰ê·  ê±°ë˜ê°€ê²© ì¶”ì´</h2>
                <div class="relative h-72 md:h-96 w-full">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- ë°ì´í„° í…Œì´ë¸” ì˜ì—­ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 lg:col-span-1 flex flex-col">
                <div class="p-6 pb-0 border-b border-gray-100 mb-2">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">ìµœê·¼ ê±°ë˜ ëª©ë¡</h2>
                </div>
                <div class="table-container p-2 flex-grow">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-4 py-3 font-medium text-gray-500 rounded-tl-lg">ê±°ë˜ì¼ì</th>
                                <th class="px-4 py-3 font-medium text-gray-500">ì•„íŒŒíŠ¸ëª…</th>
                                <th class="px-4 py-3 font-medium text-gray-500">ë©´ì /ì¸µ</th>
                                <th class="px-4 py-3 font-medium text-gray-500 text-right rounded-tr-lg">ê±°ë˜ê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-gray-100">
                            <!-- JSë¥¼ í†µí•´ í–‰ ë°ì´í„°ê°€ ì‚½ì…ë©ë‹ˆë‹¤ -->
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-400">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // êµ¬ê¸€ ì‹œíŠ¸ CSV ë°ì´í„° URL
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSU0z2hHAKbA3GTukjrC-0IWWYfq4D0EDvteaTspKk7AY3xmUYtvnEwii8L3M4y4SKYzcVmG8ooaLr3/pub?gid=1498610887&single=true&output=csv";

        // í•œêµ­ í†µí™”(ë§Œ ì› ë‹¨ìœ„) í¬ë§· í•¨ìˆ˜
        function formatKoreanCurrency(amountInManwon) {
            if (isNaN(amountInManwon)) return "-";
            if (amountInManwon >= 10000) {
                const uk = Math.floor(amountInManwon / 10000);
                const remainder = amountInManwon % 10000;
                if (remainder > 0) {
                    return `${uk}ì–µ ${remainder.toLocaleString()}ë§Œì›`;
                } else {
                    return `${uk}ì–µì›`;
                }
            }
            return `${amountInManwon.toLocaleString()}ë§Œì›`;
        }

        // ë°ì´í„° ë¡œë“œ ë° ì´ˆê¸°í™”
        document.addEventListener("DOMContentLoaded", () => {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    document.getElementById('loadingStatus').innerText = "ë°ì´í„° ë¡œë“œ ì™„ë£Œ";
                    document.getElementById('loadingStatus').classList.remove('animate-pulse', 'text-blue-600');
                    document.getElementById('loadingStatus').classList.add('text-green-600');
                    
                    setTimeout(() => {
                        document.getElementById('loadingStatus').style.display = 'none';
                    }, 3000);

                    processData(results.data);
                },
                error: function(error) {
                    console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                    document.getElementById('loadingStatus').innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
                    document.getElementById('loadingStatus').classList.remove('text-blue-600');
                    document.getElementById('loadingStatus').classList.add('text-red-500');
                }
            });
        });

        function processData(rawData) {
            // í—¤ë”ì˜ ê³µë°± ì œê±° ë° ìœ íš¨í•œ ë°ì´í„°ë§Œ í•„í„°ë§
            const cleanedData = rawData.map(row => {
                const cleanRow = {};
                for (let key in row) {
                    cleanRow[key.trim()] = row[key].trim();
                }
                return cleanRow;
            }).filter(row => row['ê±°ë˜ê¸ˆì•¡(ë§Œì›)'] && row['ê±°ë˜ì¼ì']);

            if (cleanedData.length === 0) {
                alert("ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—´ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ê±°ë˜ê¸ˆì•¡ì„ ìˆ«ìë¡œ ë³€í™˜
            const parsedData = cleanedData.map(row => {
                let priceStr = row['ê±°ë˜ê¸ˆì•¡(ë§Œì›)'].replace(/,/g, '');
                let price = parseInt(priceStr, 10);
                
                // ê±°ë˜ì¼ì í¬ë§·íŒ… (YYYY-MM-DD ë˜ëŠ” YYYY.MM.DD ëŒ€ì‘)
                let rawDate = row['ê±°ë˜ì¼ì'];
                let formattedDate = rawDate.replace(/\./g, '-').replace(/\//g, '-');
                
                // ì›”ë³„ ê·¸ë£¹í™”ë¥¼ ìœ„í•´ YYYY-MM ì¶”ì¶œ
                let monthStr = "Unknown";
                if (formattedDate.length >= 7) {
                    monthStr = formattedDate.substring(0, 7); 
                }

                return {
                    ...row,
                    priceNum: price,
                    dateStr: formattedDate,
                    month: monthStr
                };
            });

            // ë‚ ì§œ ìµœì‹ ìˆœ ì •ë ¬
            parsedData.sort((a, b) => new Date(b.dateStr) - new Date(a.dateStr));

            updateKPIs(parsedData);
            renderChart(parsedData);
            renderTable(parsedData);
        }

        // ìš”ì•½ ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateKPIs(data) {
            const prices = data.map(d => d.priceNum).filter(p => !isNaN(p));
            
            if (prices.length === 0) return;

            const totalCount = prices.length;
            const maxPrice = Math.max(...prices);
            const minPrice = Math.min(...prices);
            const avgPrice = Math.round(prices.reduce((sum, val) => sum + val, 0) / totalCount);

            // DOM ì• ë‹ˆë©”ì´ì…˜ ì¹´ìš´íŠ¸ì—… (ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ í…ìŠ¤íŠ¸ ì¦‰ì‹œ ëŒ€ì…)
            document.getElementById('kpi-count').innerText = `${totalCount.toLocaleString()} ê±´`;
            document.getElementById('kpi-avg').innerText = formatKoreanCurrency(avgPrice);
            document.getElementById('kpi-max').innerText = formatKoreanCurrency(maxPrice);
            document.getElementById('kpi-min').innerText = formatKoreanCurrency(minPrice);
        }

        // ì°¨íŠ¸ ë Œë”ë§
        function renderChart(data) {
            const monthlyStats = {};

            // ì›”ë³„ë¡œ ê°€ê²© ëª¨ìœ¼ê¸°
            data.forEach(row => {
                if (row.month !== "Unknown" && !isNaN(row.priceNum)) {
                    if (!monthlyStats[row.month]) {
                        monthlyStats[row.month] = { sum: 0, count: 0 };
                    }
                    monthlyStats[row.month].sum += row.priceNum;
                    monthlyStats[row.month].count += 1;
                }
            });

            // ë¼ë²¨(ì›”)ê³¼ ë°ì´í„°(í‰ê· ê°€ê²©) ë¶„ë¦¬ í›„ ì‹œê°„ìˆœ ì •ë ¬
            const labels = Object.keys(monthlyStats).sort();
            const avgPrices = labels.map(month => {
                return Math.round(monthlyStats[month].sum / monthlyStats[month].count);
            });

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì›”ë³„ í‰ê·  ê±°ë˜ê°€ê²© (ë§Œì›)',
                        data: avgPrices,
                        borderColor: '#3b82f6', // Tailwind blue-500
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#3b82f6',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: 0.3 // ë¶€ë“œëŸ¬ìš´ ê³¡ì„ 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatKoreanCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatKoreanCurrency(value);
                                }
                            },
                            grid: {
                                color: '#f3f4f6', // Tailwind gray-100
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                }
            });
        }

        // ê±°ë˜ ëª©ë¡ í…Œì´ë¸” ë Œë”ë§
        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors duration-150";

                const dateStr = row['ê±°ë˜ì¼ì'] || '-';
                const aptName = row['ì•„íŒŒíŠ¸ëª…'] || '-';
                const area = row['ì „ìš©ë©´ì (ã¡)'] || '-';
                const floor = row['ì¸µ'] || '-';
                
                // ë²•ì •ë™ ì •ë³´ê°€ ìˆìœ¼ë©´ ì•„íŒŒíŠ¸ëª… ì•„ë˜ì— ì‘ê²Œ í‘œì‹œ
                const dong = row['ë²•ì •ë™'] ? `<div class="text-xs text-gray-400 mt-0.5">${row['ë²•ì •ë™']}</div>` : '';

                tr.innerHTML = `
                    <td class="px-4 py-3 text-gray-600">${dateStr}</td>
                    <td class="px-4 py-3 font-medium text-gray-800">
                        ${aptName}
                        ${dong}
                    </td>
                    <td class="px-4 py-3 text-gray-500">${area}ã¡ <span class="text-gray-300 mx-1">|</span> ${floor}ì¸µ</td>
                    <td class="px-4 py-3 text-right font-bold text-gray-800">${formatKoreanCurrency(row.priceNum)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
